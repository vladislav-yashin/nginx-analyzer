name: Lint and Run with Docker

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint with ruff

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image with dev deps
        run: |
          docker build -t nginx-analyzer .

      - name: Run ruff
        run: |
          docker run --rm \
            --entrypoint=poetry \
            nginx-analyzer \
            run ruff check src

  docker:
    runs-on: ubuntu-latest
    needs: lint
    name: Run app and generate report

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create logs and reports directories
        run: |
          mkdir -p logs reports

      - name: Build Docker image
        run: |
          docker build -t nginx-analyzer .

      - name: Run app in Docker
        run: |
          docker run --rm \
            -v ${PWD}/reports:/app/reports \
            nginx-analyzer

      - name: Verify report.json
        run: |
          if [ -f "reports/report.json" ]; then
            echo "✅ report.json создан."
            cat reports/report.json
          else
            echo "❌ report.json не найден!"
            ls -la reports/
            exit 1
          fi
